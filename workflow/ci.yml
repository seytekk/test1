  name: CI

  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

  permissions:
    contents: read

  jobs:
    ruff:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v5
          with:
            python-version: "3.11"
        - name: Install deps (ruff)
          run: |
            python -m pip install --upgrade pip
            pip install ruff
        - name: Ruff check
          run: ruff check .

    tests:
      runs-on: ubuntu-latest
      services:
        postgres:
          image: postgres:16-alpine
          env:
            POSTGRES_DB: appdb_test
            POSTGRES_USER: appuser
            POSTGRES_PASSWORD: secretpassword
          ports:
            - 5432:5432
          options: >-
            --health-cmd="pg_isready -U appuser -d appdb_test"
            --health-interval=5s
            --health-timeout=5s
            --health-retries=20

      env:
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        DJANGO_SETTINGS_MODULE: bloglite.settings
        DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        DJANGO_DEBUG: "0"

      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v5
          with:
            python-version: "3.11"

        - name: Cache pip
          uses: actions/cache@v4
          with:
            path: ~/.cache/pip
            key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
            restore-keys: |
              ${{ runner.os }}-pip-

        - name: Install deps
          run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt

        - name: Prepare DB (migrations)
          run: |
            python bloglite/manage.py migrate --noinput
            python bloglite/manage.py check

        - name: Run Django tests (all)
          run: |
            python bloglite/manage.py test -v 2